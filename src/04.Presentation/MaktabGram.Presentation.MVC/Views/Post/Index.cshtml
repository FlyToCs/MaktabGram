@using MaktabGram.Domain.PostAgg.Dtos
@model List<GetPostForFeedsDto>;
@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
    Layout = "";
}


<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مکتب گرام | MaktabGram</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vazirmatn Font (Persian) -->
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /*
                 * استایل‌های MaktabGram
                 * تمام استایل‌های سفارشی CSS برای عملکرد بهتر در اینجا قرار گرفته‌اند.
                 */

        /* تنظیم فونت و رنگ‌های اصلی */
        body {
            font-family: 'Vazirmatn', sans-serif;
            /* پس‌زمینه گرم و ملایم */
            background-color: #EBEBEB;
            color: #262626;
        }

        /* استایل خاص برای حلقه گرادینت دور استوری - ظاهر جدید و شیک‌تر */
        .story-border {
            padding: 3px; /* کمی ضخیم‌تر شد برای تاکید بیشتر */
            /* گرادینت جدید: بنفش، صورتی، زرد (شیک‌تر و متفاوت‌تر) */
            background: linear-gradient(45deg, #6B46C1, #F687B3, #FBBF24);
            border-radius: 50%;
            cursor: pointer;
            flex-shrink: 0;
            box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.5);
            ش
        }

        /* اسکرول‌بار مخفی برای نوار استوری */
        .story-reel::-webkit-scrollbar {
            display: none;
        }

        .story-reel {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* انیمیشن لایک (قلب روی عکس) */
        .like-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* اسپرینگ افکت */
            color: white;
            opacity: 0;
            font-size: 80px;
            text-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }

            .like-overlay.show {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }

        /* استایل مدرن دکمه‌های اکشن */
        .action-btn {
            transition: color 0.15s ease-in-out, transform 0.1s ease-out;
        }

            .action-btn:hover {
                color: #555;
                transform: translateY(-1px);
            }

        /* Responsive adjustments for main layout */
        media (min-width: 1024px) {
            .main-layout

        {
            width: 630px;
            max-width: 100%;
            margin: 0 auto;
            display: block;
            padding: 20px 0;
            padding-top: 64px;
        }
        /* استایل کارت پست در دسکتاپ به همراه Transition برای جلوه Hover */
        .post-card {
            border: none;
            border-radius: 16px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), box-shadow 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
            /* استایل Hover: سایه قوی‌تر و مقیاس جزئی */
            .post-card:hover {
                box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
                transform: scale(1.005);
                cursor: pointer;
            }

        }
        media (max-width: 1023px) {
            .feed-container

        {
            padding: 0;
        }

        }
    </style>
</head>
<body class="overflow-x-hidden">

    <!-- منطق جاوا اسکریپت - شامل Base64 Placeholder Creator و مدیریت تعاملات -->
    <script>
        // تابع کمکی برای ساخت آواتار Placeholder با حرف (برای پروفایل‌ها)
        function createAvatarPlaceholder(initial, color) {
            const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="50" fill="${color}"/>
                <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-size="50px" fill="#FFFFFF" font-family="Vazirmatn, sans-serif">${initial}</text>
            </svg>`;
            return 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));
        }

        // تابع کمکی جدید برای ساخت Placeholder دایره‌ای ساده (برای استوری‌ها)
        function createCirclePlaceholder(color) {
            const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="50" fill="${color}"/>
            </svg>`;
            return 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));
        }

        // تابع کمکی برای ساخت تصویر پست Placeholder (متن حذف شده)
        function createPostPlaceholder(text, colorStart, colorEnd) {
            const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 600 600">
                <defs>
                    <linearGradient id="g" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:${colorStart};stop-opacity:1" />
                        <stop offset="100%" style="stop-color:${colorEnd};stop-opacity:1" />
                    </linearGradient>
                </defs>
                <rect width="600" height="600" fill="url(#g)" rx="15"/>
            </svg>`;
            return 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svg)));
        }

        // مقادیر ثابت Base64 برای استفاده در HTML
        const avatarP = createAvatarPlaceholder('P', '#3B82F6');
        const avatarU = createAvatarPlaceholder('U', '#262626');

        // Placeholderهای استوری (فقط رنگ)
        const storyM = createCirclePlaceholder('#9333EA');
        const storyA = createCirclePlaceholder('#10B981');
        const storyY = createCirclePlaceholder('#EF4444');
        const storyAA = createCirclePlaceholder('#F59E0B');
        const storyS = createCirclePlaceholder('#06B6D4');
        const storyR = createCirclePlaceholder('#A855F7');

        // تعریف گرادینت‌های متمایز برای تصاویر پست‌ها
        const post1 = createPostPlaceholder('', '#FFC700', '#FF0054');
        const post2 = createPostPlaceholder('', '#34D399', '#1D4ED8');

        // تابع جایگذاری خودکار در HTML
        window.onload = function() {
            document.querySelector('.header-avatar-img').src = avatarP;

            // جایگذاری تصاویر استوری‌ها با دایره‌های رنگی
            document.querySelectorAll('.story-reel img').forEach((img, index) => {
                const placeholders = [storyM, storyA, storyY, storyAA, storyS, storyR];
                img.src = placeholders[index % placeholders.length];
            });

            document.querySelector('.post-media-area[data-post-id="1"] img').src = post1;
            document.querySelector('.post-media-area[data-post-id="2"] img').src = post2;

            document.querySelectorAll('.post-card .post-header-avatar img').forEach(img => {
                 img.src = avatarU;
            });

            initPostInteractions();
            initCommentInteractions();
            lucide.createIcons();
        };

        // --- 1. لاگیک لایک با دو بار کلیک روی پست ---
        function initPostInteractions() {
            document.querySelectorAll('.post-media-area').forEach(mediaArea => {
                const likeOverlay = mediaArea.querySelector('.like-overlay');

                // رویداد دو بار کلیک روی تصویر
                mediaArea.addEventListener('dblclick', function() {
                    const heartIcon = this.closest('.post-card').querySelector('.icon-like');

                    // نمایش انیمیشن قلب بزرگ
                    likeOverlay.classList.add('show');
                    setTimeout(() => {
                        likeOverlay.classList.remove('show');
                    }, 800);

                    // تغییر آیکون لایک زیر پست به حالت پر
                    if (!heartIcon.classList.contains('fill-red-500')) {
                        heartIcon.classList.add('fill-red-500', 'text-red-500');
                        heartIcon.classList.remove('fill-none', 'text-gray-800');
                    }
                });
            });

            // --- 2. لاگیک کلیک روی دکمه لایک پست ---
            document.querySelectorAll('.action-btn[data-action="like"]').forEach(likeButton => {
                likeButton.addEventListener('click', function() {
                    const heartIcon = this.querySelector('.icon-like');

                    if (heartIcon.classList.contains('fill-red-500')) {
                        // لغو لایک
                        heartIcon.classList.remove('fill-red-500', 'text-red-500');
                        heartIcon.classList.add('fill-none', 'text-gray-800');
                    } else {
                        // لایک
                        heartIcon.classList.add('fill-red-500', 'text-red-500');
                        heartIcon.classList.remove('fill-none', 'text-gray-800');
                    }
                    lucide.createIcons();
                });
            });
        }

        // --- 3. لود مجدد آیکون‌ها پس از تغییر رنگ/حالت (هدر) ---
        function toggleNotifications(e) {
            e.preventDefault();
            const icon = e.currentTarget.querySelector('span');
            icon.classList.toggle('fill-black');
            lucide.createIcons();
        }

        // --- 4. لاگیک لایک کامنت (جدید) ---
        function initCommentInteractions() {
            document.querySelectorAll('.comment-like-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const heartIcon = this.querySelector('.comment-heart-icon');
                    const likeCountSpan = this.querySelector('.comment-like-count');
                    let currentCount = parseInt(likeCountSpan.textContent);

                    if (heartIcon.classList.contains('fill-red-500')) {
                        // لغو لایک
                        heartIcon.classList.remove('fill-red-500', 'text-red-500', 'fill-current');
                        heartIcon.classList.add('fill-none', 'text-gray-400');
                        likeCountSpan.textContent = currentCount - 1;
                    } else {
                        // لایک
                        heartIcon.classList.add('fill-red-500', 'text-red-500', 'fill-current');
                        heartIcon.classList.remove('fill-none', 'text-gray-400');
                        likeCountSpan.textContent = currentCount + 1;
                    }
                    lucide.createIcons();
                });
            });
        }
    </script>

    <!-- نوار ناوبری بالا (Header) - ثابت -->
    <header class="fixed top-0 right-0 w-full bg-white border-b border-gray-100 z-50 shadow-lg">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 h-14 flex items-center justify-between">
            <!-- لوگو -->
            <div class="text-2xl font-bold tracking-tight text-gray-800">مکتب گرام</div>

            <!-- جستجو (فقط در دسکتاپ) -->
            <div class="hidden lg:block">
                <div class="relative">
                    <input type="text" placeholder="جستجو" class="p-2 pr-10 text-sm bg-gray-100 border border-gray-200 rounded-lg w-64 focus:outline-none focus:ring-1 focus:ring-gray-400 transition duration-150">
                    <span data-lucide="search" class="absolute top-1/2 transform -translate-y-1/2 right-3 w-5 h-5 text-gray-500"></span>
                </div>
            </div>

            <!-- آیکون‌ها -->
            <nav class="flex space-x-6 space-x-reverse items-center">
                <a href="#" class="text-gray-800 hover:text-gray-900" title="خانه"><span data-lucide="home" class="w-6 h-6 fill-black"></span></a>
                <a href="#" class="text-gray-800 hover:text-gray-900" title="پیام‌ها"><span data-lucide="send" class="w-6 h-6"></span></a>
                <a href="#" class="text-gray-800 hover:text-gray-900" title="افزودن پست"><span data-lucide="plus-square" class="w-6 h-6"></span></a>
                <a href="#" class="text-gray-800 hover:text-gray-900" title="اکسپلور"><span data-lucide="compass" class="w-6 h-6"></span></a>
                <a href="#" class="text-gray-800 hover:text-gray-900" title="اعلان‌ها" onclick="toggleNotifications(event)"><span data-lucide="heart" class="w-6 h-6"></span></a>
                <!-- آواتار پروفایل -->
                <div class="w-7 h-7 rounded-full overflow-hidden border-2 border-gray-600">
                    <img src="" alt="عکس پروفایل" class="header-avatar-img w-full h-full object-cover">
                </div>
            </nav>
        </div>
    </header>

    <!-- محتوای اصلی -->
    <main class="main-layout pt-16">

        <!-- ستون وسط: فید پست‌ها و استوری‌ها -->
        <div class="feed-container px-0 md:px-4 lg:px-0">

            <!-- نوار استوری‌ها - مرکزیت در دسکتاپ حفظ شده است -->
            <div class="story-reel flex items-center p-3 mb-6 lg:mb-10 bg-white border border-gray-200 lg:border lg:rounded-lg lg:shadow-md overflow-x-scroll lg:justify-center">
                <!-- آیتم استوری - تکرار شود -->
                <div class="text-center ml-4">
                    <div class="story-border">
                        <div class="w-16 h-16 rounded-full overflow-hidden border-2 border-white">
                            <img src="" alt="استوری کاربر مسعود" class="w-full h-full object-cover">
                        </div>
                    </div>
                    <p class="text-xs mt-1 truncate w-16">مسعود</p>
                </div>
                <div class="text-center ml-4">
                    <div class="story-border">
                        <div class="w-16 h-16 rounded-full overflow-hidden border-2 border-white">
                            <img src="" alt="استوری کاربر آرش" class="w-full h-full object-cover">
                        </div>
                    </div>
                    <p class="text-xs mt-1 truncate w-16">آرش</p>
                </div>
                <div class="text-center ml-4">
                    <div class="story-border">
                        <div class="w-16 h-16 rounded-full overflow-hidden border-2 border-white">
                            <img src="" alt="استوری کاربر مریم" class="w-full h-full object-cover">
                        </div>
                    </div>
                    <p class="text-xs mt-1 truncate w-16">مریم</p>
                </div>
                <div class="text-center ml-4">
                    <div class="story-border">
                        <div class="w-16 h-16 rounded-full overflow-hidden border-2 border-white">
                            <img src="" alt="استوری کاربر علی" class="w-full h-full object-cover">
                        </div>
                    </div>
                    <p class="text-xs mt-1 truncate w-16">علی</p>
                </div>
                <div class="text-center ml-4">
                    <div class="story-border">
                        <div class="w-16 h-16 rounded-full overflow-hidden border-2 border-white">
                            <img src="" alt="استوری کاربر سارا" class="w-full h-full object-cover">
                        </div>
                    </div>
                    <p class="text-xs mt-1 truncate w-16">سارا</p>
                </div>
                <!-- برای پر کردن فضای اسکرول -->
                <div class="text-center ml-4">
                    <div class="story-border">
                        <div class="w-16 h-16 rounded-full overflow-hidden border-2 border-white">
                            <img src="" alt="استوری کاربر رضا" class="w-full h-full object-cover">
                        </div>
                    </div>
                    <p class="text-xs mt-1 truncate w-16">رضا</p>
                </div>
            </div>

            <!-- بخش فید پست‌ها -->
            <section id="posts-feed" class="flex flex-col items-center">
                
                @foreach(var post in @Model)
                {
                    <article class="post-card w-full lg:max-w-lg bg-white rounded-lg lg:rounded-2xl mb-8 shadow-sm lg:shadow-lg transition-all duration-300 hover:shadow-xl hover:scale-[1.005]">
                        <!-- هدر پست -->
                        <div class="flex items-center justify-between p-3">
                            <div class="flex items-center">
                                <div class="w-8 h-8 rounded-full overflow-hidden ml-3 post-header-avatar">
                                    <img src="@post.ProfileImgUrl" alt="آواتار" class="w-full h-full object-cover">
                                </div>
                                <span class="font-semibold text-sm">@post.Username</span>
                            </div>
                            <span data-lucide="ellipsis" class="w-5 h-5 text-gray-700 cursor-pointer hover:text-black"></span>
                        </div>

                        <!-- بخش رسانه (عکس یا ویدیو) -->
                        <div class="w-full aspect-square border-t border-b border-gray-100" data-post-id="1">
                            <img src="@post.ImgPostUrl" alt="عکس پست" class="w-full h-full object-cover">
                        </div>

                        <!-- اکشن‌ها (لایک، کامنت، ارسال، ذخیره) -->
                        <div class="p-4">
                            <div class="flex justify-between items-center mb-3">
                                <div class="flex space-x-5 space-x-reverse">
                                    <button class="action-btn" data-action="like"><span data-lucide="heart" class="icon-like w-6 h-6 text-gray-800 fill-none"></span></button>
                                    <button class="action-btn"><span data-lucide="message-circle" class="w-6 h-6 text-gray-800"></span></button>
                                    <button class="action-btn"><span data-lucide="send" class="w-6 h-6 text-gray-800"></span></button>
                                </div>
                                <button class="action-btn"><span data-lucide="bookmark" class="w-6 h-6 text-gray-800"></span></button>
                            </div>

                            <!-- آمار لایک‌های پست اصلی -->
                            <p class="text-sm font-semibold mb-1">@post.LikeCount لایک</p>
                            <!-- متن کپشن طولانی‌تر -->
                            <p class="text-sm mb-2">
                                <span class="font-semibold ml-1">@post.Username</span>
                                @post.Caption
                            </p>
                            <p class="text-xs text-gray-500 cursor-pointer mb-2 hover:text-gray-700">مشاهده همه @post.Comments.Count کامنت</p>
                            <!-- بخش کامنت‌ها - کامنت‌های نمونه برای نمایش لایک کامنت -->
                            <div class="text-sm mb-1">
                                <p class="text-xs text-gray-400 mb-1">@post.CreateAt</p>

                                @foreach(var comment in post.Comments)
                                {
                                    <!-- کامنت ۱ با قابلیت لایک و نمایش تعداد لایک -->
                                    <div class="flex justify-between items-center group mb-1">
                                        <div class="flex items-start">
                                            <span class="font-semibold ml-1">@comment.User.Username</span>
                                            <span class="text-gray-700">@comment.Text</span>
                                        </div>
                                        <button class="comment-like-btn invisible group-hover:visible transition duration-150 p-1 -m-1 flex items-center" data-action="comment-like">
                                            <span data-lucide="heart" class="comment-heart-icon w-3 h-3 text-gray-400 fill-none hover:text-red-500"></span>
                                            <span class="comment-like-count text-[10px] text-gray-400 mr-0.5">3</span>
                                        </button>
                                    </div>
                                }

                            </div>
                        </div>
                    </article>

                }

            </section>

            <footer class="text-center text-xs text-gray-400 p-8">
                <p>درباره ما · کمک · API · حریم خصوصی · شرایط · مکان‌ها · زبان فارسی</p>
                <p class="mt-2">© 2025 MaktabGram from Google</p>
            </footer>

        </div>

    </main>

</body>
</html>
